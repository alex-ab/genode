<runtime ram="600M" caps="2400" binary="init">

	<requires>
		<gui/>
		<timer/>
		<file_system label="source" writeable="yes"/>
		<file_system label="fonts"  writeable="no"/>
		<rom    label="vimrc"/>
		<rom    label="clipboard"/>
		<report label="clipboard"/>
		<rtc/>
		<rm/>
	</requires>

	<content>
		<rom label="ld.lib.so"/>
		<rom label="libc.lib.so"/>
		<rom label="libm.lib.so"/>
		<rom label="init"/>
		<rom label="vfs"/>
		<rom label="vfs.lib.so"/>
		<rom label="vfs_pipe.lib.so"/>
		<rom label="cached_fs_rom"/>
		<rom label="terminal"/>
		<rom label="posix.lib.so"/>
		<rom label="ncurses.lib.so"/>
		<rom label="gmp.lib.so"/>
		<rom label="mpc.lib.so"/>
		<rom label="mpfr.lib.so"/>
		<rom label="stdcxx.lib.so"/>
		<rom label="pcre.lib.so"/>
		<rom label="bash.tar"/>
		<rom label="binutils_x86.tar"/>
		<rom label="coreutils.tar"/>
		<rom label="findutils.tar"/>
		<rom label="gcc.tar"/>
		<rom label="grep.tar"/>
		<rom label="make.tar"/>
		<rom label="sed.tar"/>
		<rom label="tclsh.tar"/>
		<rom label="vim.tar"/>
		<rom label="which.tar"/>
	</content>

	<config>
		<parent-provides>
			<service name="ROM"/>
			<service name="PD"/>
			<service name="RM"/>
			<service name="CPU"/>
			<service name="LOG"/>
			<service name="Timer"/>
			<service name="File_system"/>
			<service name="Gui"/>
			<service name="Report"/>
			<service name="Rtc"/>
		</parent-provides>

		<default-route> <any-service> <parent/> <any-child/> </any-service> </default-route>

		<start name="terminal" caps="100">
			<resource name="RAM" quantum="16M"/>
			<provides> <service name="Terminal"/> </provides>
			<config copy="yes" paste="yes">
				<initial width="800" height="600"/>
				<vfs> <dir name="fonts"> <fs/> </dir> </vfs>
			</config>
			<route>
				<service name="File_system"> <parent label="fonts"/>    </service>
				<service name="Gui">         <parent label="terminal"/> </service>
				<service name="Report" label="clipboard"> <parent label="clipboard"/> </service>
				<service name="ROM"    label="clipboard"> <parent label="clipboard"/> </service>
				<any-service> <parent/> <any-child/> </any-service>
			</route>
		</start>

		<start name="vfs" caps="300">
			<resource name="RAM" quantum="200M"/>
			<provides><service name="File_system"/></provides>
			<config ld_verbose="yes">
				<vfs>
					<tar name="bash.tar" />
					<tar name="coreutils.tar" />
					<tar name="vim.tar" />
					<tar name="grep.tar" />
					<tar name="sed.tar" />
					<tar name="findutils.tar" />
					<tar name="make.tar" />
					<tar name="which.tar" />
					<tar name="tclsh.tar" />

					<dir name="dev">
						<zero/> <null/> <terminal/>
						<log/>
						<rtc/>
					</dir>

					<dir name="pipe"> <pipe/> </dir>

					<dir name="source"> <fs label="source"/> </dir>

					<dir name="tmp"> <ram /> </dir>

					<dir name="usr">
						<!--
							Why not using the defined /usr/local/genode/tool/19.05 path ?

							Length limitations of Labels for ROMs to be started
							lead to cut off paths and binaries, e.g.

							/usr/local/genode/tool/19.05/libexec/gcc/x86_64-pc-elf/8.3.0/cc

							instead of

							/usr/local/genode/tool/19.05/libexec/gcc/x86_64-pc-elf/8.3.0/cc1plus
						-->
						<dir name="tool">
							<dir name="19.05">
								<tar name="gcc.tar" />
								<tar name="binutils_x86.tar" />
							</dir>
						</dir>

						<dir name="bin">
							<symlink name="make"  target="/bin/make" />
							<symlink name="mkdir" target="/bin/mkdir"/>
							<symlink name="echo"  target="/bin/echo" />
							<symlink name="tclsh" target="/bin/tclsh"/>
						</dir>
					</dir>

					<dir name="bin">
						<symlink name="ld" target="/usr/tool/19.05/bin/genode-x86-ld"/>
						<symlink name="nm" target="/usr/tool/19.05/bin/genode-x86-nm"/>
						<symlink name="sh" target="bash"/>
					</dir>

					<dir name="home">
						<ram/>
						<inline name=".bash_history">
make -C build/x86_64 KERNEL=hw test/log
make -C build/x86_64 KERNEL=hw core
						</inline>
						<inline name=".bash_profile">
cd /home
/source/tool/create_builddir BUILD_DIR=/home/build/x86_64 x86_64
echo "CROSS_DEV_PREFIX=/usr/tool/19.05/bin/genode-x86-" >>build/x86_64/etc/tools.conf
						</inline>
					</dir>

					<dir name="share">
						<dir name="vim">
							<rom name="vimrc" binary="no"/>
						</dir>
					</dir>
				</vfs>

				<policy label_prefix="vfs_rom" root="/"/>
				<default-policy root="/" writeable="yes"/>
			</config>

			<route>
				<service name="File_system" label="source"> <parent label="source"/> </service>
				<service name="ROM" label="vimrc"> <parent label="vimrc"/> </service>
				<service name="Terminal"> <child name="terminal"/> </service>
				<any-service> <parent/> </any-service>
			</route>
		</start>

		<start name="vfs_rom" caps="100">
			<resource name="RAM" quantum="128M"/>
			<binary name="cached_fs_rom"/>
			<provides> <service name="ROM"/> </provides>
			<config/>
			<route>
				<service name="File_system"> <child name="vfs"/> </service>
				<any-service> <parent/> </any-service>
			</route>
		</start>

		<start name="/bin/bash" caps="1800">
			<resource name="RAM" quantum="220M" />
			<exit propagate="yes"/>
			<config>
				<libc stdin="/dev/terminal" stdout="/dev/terminal"
				      stderr="/dev/terminal" rtc="/dev/rtc" pipe="/pipe"/>
				<vfs> <fs/> </vfs>
				<env key="TERM" value="screen"/>
				<env key="PATH" value="/bin:/usr/tool/19.05/bin"/>
				<env key="PS1"  value="system:$PWD> " />
				<env key="HOME" value="/home"/>
				<arg value="/bin/bash"/>
				<arg value="--login" />
			</config>
			<route>
				<service name="File_system"> <child name="vfs"/> </service>
				<service name="ROM" label_suffix=".lib.so"> <parent/> </service>
				<service name="ROM" label_last="/bin/bash"> <child name="vfs_rom"/> </service>
				<service name="ROM" label_prefix="/bin">    <child name="vfs_rom"/> </service>
				<service name="ROM" label_prefix="/source/tool"> <child name="vfs_rom"/> </service>
				<service name="ROM" label_prefix="/usr/tool/19.05"> <child name="vfs_rom"/> </service>
				<any-service> <parent/> <any-child/> </any-service>
			</route>
		</start>

	</config>

</runtime>
